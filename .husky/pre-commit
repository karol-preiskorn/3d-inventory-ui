#!/usr/bin/bash
# File:        /.husky/pre-commit
# Description: Comprehensive pre-commit checks for Angular UI
# 2025-11-14   Enhanced   Added security checks, TypeScript validation, and strict linting

. "$(dirname "$0")/_/husky.sh"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

echo -e "${PURPLE}ğŸ”’ STRICT MODE: Pre-commit quality gates${NC}"
echo -e "${BLUE}ğŸ” Running pre-commit checks...${NC}"

# 1. Security Checks
echo -e "${BLUE}ğŸ”’ Checking for hardcoded secrets...${NC}"

# Check for potential passwords (excluding test files and form controls)
if grep -r "password.*=.*['\"]" src/ --include="*.ts" --exclude="*.spec.ts" | grep -v "formControl" | grep -v "FormControl" | grep -v "Validators" | grep -v "passwordControl"; then
  echo -e "${RED}âŒ Potential hardcoded password detected!${NC}"
  echo -e "${YELLOW}ğŸ’¡ Use environment variables or configuration files for sensitive data${NC}"
  exit 1
fi

# Check for API keys
if grep -r "api.*key.*=.*['\"]" src/ --include="*.ts" --exclude="*.spec.ts" | grep -v "environment" | grep -v "// "; then
  echo -e "${RED}âŒ Potential hardcoded API key detected!${NC}"
  echo -e "${YELLOW}ğŸ’¡ Use environment.ts or environment.prod.ts for API keys${NC}"
  exit 1
fi

# Check for tokens
if grep -r "token.*=.*['\"]" src/ --include="*.ts" --exclude="*.spec.ts" | grep -v "mock" | grep -v "test" | grep -v "Mock" | grep -v "// " | grep -v "getToken" | grep -v "setToken"; then
  echo -e "${RED}âŒ Potential hardcoded token detected!${NC}"
  echo -e "${YELLOW}ğŸ’¡ Tokens should be stored securely, not in source code${NC}"
  exit 1
fi

echo -e "${GREEN}âœ… No hardcoded secrets found${NC}"

# 2. Check for staged files
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|js)$' | tr '\n' ' ')
STAGED_HTML_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.html$' | tr '\n' ' ')

if [ -z "$STAGED_TS_FILES" ] && [ -z "$STAGED_HTML_FILES" ]; then
  echo -e "${YELLOW}âš ï¸  No TypeScript/JavaScript/HTML files staged for commit${NC}"
  # Continue with version bump even if no TS files
else
  echo -e "${BLUE}ğŸ“ Found staged files to validate${NC}"

  # 3. Run lint-staged for auto-formatting
  echo -e "${BLUE}ğŸ§¹ Running lint-staged (Prettier + ESLint)...${NC}"
  npx lint-staged

  if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ Lint-staged failed. Please fix the issues and try again.${NC}"
    exit 1
  fi

  echo -e "${GREEN}âœ… Lint-staged completed successfully${NC}"

  # 4. TypeScript Type Check
  if [ -n "$STAGED_TS_FILES" ]; then
    echo -e "${BLUE}ğŸ” Running TypeScript type check...${NC}"
    npx tsc --noEmit

    if [ $? -ne 0 ]; then
      echo -e "${RED}âŒ TypeScript compilation errors detected!${NC}"
      echo -e "${YELLOW}ğŸ’¡ Fix type errors before committing${NC}"
      exit 1
    fi

    echo -e "${GREEN}âœ… TypeScript type check passed${NC}"
  fi

  # 5. Strict ESLint Check (ensure no errors remain)
  if [ -n "$STAGED_TS_FILES" ]; then
    echo -e "${BLUE}ğŸ” Running strict ESLint validation...${NC}"
    npx eslint $STAGED_TS_FILES --max-warnings 0

    if [ $? -ne 0 ]; then
      echo -e "${RED}âŒ ESLint errors or warnings detected!${NC}"
      echo -e "${YELLOW}ğŸ’¡ Fix all ESLint issues before committing${NC}"
      exit 1
    fi

    echo -e "${GREEN}âœ… ESLint validation passed (0 errors, 0 warnings)${NC}"
  fi

  # 6. Angular Template Security Check
  if [ -n "$STAGED_HTML_FILES" ]; then
    echo -e "${BLUE}ğŸ”’ Checking Angular templates for unsafe patterns...${NC}"

    # Check for dangerous innerHTML usage
    if grep -r "\[innerHTML\]" $STAGED_HTML_FILES | grep -v "sanitized" | grep -v "safe"; then
      echo -e "${YELLOW}âš ï¸  Found [innerHTML] binding without sanitization${NC}"
      echo -e "${YELLOW}ğŸ’¡ Use DomSanitizer or avoid innerHTML for user-generated content${NC}"
    fi

    # Check for bypassSecurityTrust usage in TypeScript files
    if [ -n "$STAGED_TS_FILES" ]; then
      if echo "$STAGED_TS_FILES" | xargs grep -l "bypassSecurityTrust" 2>/dev/null; then
        echo -e "${YELLOW}âš ï¸  Found bypassSecurityTrust usage - ensure it's necessary and safe${NC}"
      fi
    fi

    echo -e "${GREEN}âœ… Template security check completed${NC}"
  fi
fi

# 7. Version Bump
echo -e "${BLUE}ğŸ”¢ Bumping version...${NC}"
npm --no-git-tag-version version minor --allow-same-version

# 8. Update yarn lock if exists
if [ -f "./scripts/yarn-lock.js" ]; then
  node ./scripts/yarn-lock.js
fi

# 9. Stage all changes (including version bump and formatting)
git add .

echo -e "${GREEN}âœ… All pre-commit checks passed!${NC}"
echo -e "${PURPLE}ğŸ‰ Ready to commit${NC}"
