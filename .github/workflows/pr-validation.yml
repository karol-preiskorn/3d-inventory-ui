name: ğŸ”„ Pull Request Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main, develop]
  pull_request_review:
    types: [submitted]

env:
  NODE_VERSION: '18'

jobs:
  # Job 1: Quick validation for draft PRs
  quick-validation:
    name: ğŸš€ Quick Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event.pull_request.draft == true

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ¯ Quick Lint Check
        run: npm run lint:check

      - name: ğŸš€ Fast Tests
        run: npm run test:fast -- --passWithNoTests

      - name: ğŸ’¬ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸš€ Quick Validation Complete

              âœ… Linting passed
              âœ… Fast tests passed

              **Draft PR Status**: Ready for development

              Convert to ready for review when complete for full validation.`
            })

  # Job 2: Full validation for ready PRs
  full-validation:
    name: ğŸ” Full PR Validation
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event.pull_request.draft == false

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ¯ ESLint Validation
        run: npm run lint:check

      - name: ğŸ’… Prettier Check
        run: npm run lint:prettier-check

      - name: ğŸ§ª Full Test Suite with Coverage
        run: npm run test:ci

      - name: ğŸ“Š Quality Gate Validation
        run: npm run quality:gate

      - name: ğŸ—ï¸ Production Build Test
        run: npm run build:prod

      - name: ğŸ“¤ Upload Coverage Results
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-pr-${{ github.event.number }}
          path: coverage/
          retention-days: 7

      - name: ğŸŒ Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: ./coverage/
          flags: pr-validation
          name: pr-${{ github.event.number }}
          fail_ci_if_error: false

  # Job 3: Coverage Analysis & PR Comment
  coverage-analysis:
    name: ğŸ“Š Coverage Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: full-validation
    if: github.event.pull_request.draft == false && always()

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Coverage Report
        uses: actions/download-artifact@v4
        with:
          name: coverage-report-pr-${{ github.event.number }}
          path: ./coverage/

      - name: ğŸ“Š Generate Coverage Badges
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            # Extract coverage data
            STATEMENTS=$(cat coverage/coverage-summary.json | grep -o '"statements":{"total":[0-9]*,"covered":[0-9]*,"skipped":[0-9]*,"pct":[0-9.]*' | grep -o 'pct":[0-9.]*' | cut -d: -f2 | head -1)
            BRANCHES=$(cat coverage/coverage-summary.json | grep -o '"branches":{"total":[0-9]*,"covered":[0-9]*,"skipped":[0-9]*,"pct":[0-9.]*' | grep -o 'pct":[0-9.]*' | cut -d: -f2 | head -1)
            FUNCTIONS=$(cat coverage/coverage-summary.json | grep -o '"functions":{"total":[0-9]*,"covered":[0-9]*,"skipped":[0-9]*,"pct":[0-9.]*' | grep -o 'pct":[0-9.]*' | cut -d: -f2 | head -1)
            LINES=$(cat coverage/coverage-summary.json | grep -o '"lines":{"total":[0-9]*,"covered":[0-9]*,"skipped":[0-9]*,"pct":[0-9.]*' | grep -o 'pct":[0-9.]*' | cut -d: -f2 | head -1)

            echo "COVERAGE_STATEMENTS=$STATEMENTS" >> $GITHUB_ENV
            echo "COVERAGE_BRANCHES=$BRANCHES" >> $GITHUB_ENV
            echo "COVERAGE_FUNCTIONS=$FUNCTIONS" >> $GITHUB_ENV
            echo "COVERAGE_LINES=$LINES" >> $GITHUB_ENV
          else
            echo "COVERAGE_STATEMENTS=0" >> $GITHUB_ENV
            echo "COVERAGE_BRANCHES=0" >> $GITHUB_ENV
            echo "COVERAGE_FUNCTIONS=0" >> $GITHUB_ENV
            echo "COVERAGE_LINES=0" >> $GITHUB_ENV
          fi

      - name: ğŸ’¬ Update PR with Coverage Report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Get coverage data from environment
            const statements = process.env.COVERAGE_STATEMENTS || '0';
            const branches = process.env.COVERAGE_BRANCHES || '0';
            const functions = process.env.COVERAGE_FUNCTIONS || '0';
            const lines = process.env.COVERAGE_LINES || '0';

            // Calculate overall score (weighted average)
            const overall = Math.round((
              parseFloat(statements) * 0.3 +
              parseFloat(branches) * 0.2 +
              parseFloat(functions) * 0.3 +
              parseFloat(lines) * 0.2
            ));

            // Generate status emojis
            const getStatus = (value, threshold) => value >= threshold ? 'âœ…' : 'âŒ';
            const getColor = (value) => {
              if (value >= 90) return 'brightgreen';
              if (value >= 80) return 'green';
              if (value >= 70) return 'yellow';
              if (value >= 60) return 'orange';
              return 'red';
            };

            // Generate badge URLs
            const badgeStyle = 'flat-square';
            const overallBadge = `https://img.shields.io/badge/Overall-${overall}%25-${getColor(overall)}?style=${badgeStyle}`;
            const statementsBadge = `https://img.shields.io/badge/Statements-${statements}%25-${getColor(statements)}?style=${badgeStyle}`;
            const branchesBadge = `https://img.shields.io/badge/Branches-${branches}%25-${getColor(branches)}?style=${badgeStyle}`;
            const functionsBadge = `https://img.shields.io/badge/Functions-${functions}%25-${getColor(functions)}?style=${badgeStyle}`;
            const linesBadge = `https://img.shields.io/badge/Lines-${lines}%25-${getColor(lines)}?style=${badgeStyle}`;

            // Determine quality gate status
            const qualityGate = (
              parseFloat(statements) >= 80 &&
              parseFloat(branches) >= 75 &&
              parseFloat(functions) >= 85 &&
              parseFloat(lines) >= 80
            ) ? 'âœ… PASSED' : 'âŒ FAILED';

            const comment = `## ğŸ“Š Test Coverage Report

            ![Overall Coverage](${overallBadge})
            ![Statements](${statementsBadge})
            ![Branches](${branchesBadge})
            ![Functions](${functionsBadge})
            ![Lines](${linesBadge})

            | Metric | Coverage | Threshold | Status |
            |--------|----------|-----------|--------|
            | **Overall** | **${overall}%** | **â‰¥80%** | **${getStatus(overall, 80)}** |
            | Statements | ${statements}% | â‰¥80% | ${getStatus(statements, 80)} |
            | Branches | ${branches}% | â‰¥75% | ${getStatus(branches, 75)} |
            | Functions | ${functions}% | â‰¥85% | ${getStatus(functions, 85)} |
            | Lines | ${lines}% | â‰¥80% | ${getStatus(lines, 80)} |

            ### ğŸ¯ Quality Gate: ${qualityGate}

            ${qualityGate.includes('FAILED') ?
              'âš ï¸ **Action Required**: Coverage below thresholds. Please add tests to meet minimum requirements.' :
              'ğŸ‰ **Great work!** All coverage thresholds met.'
            }

            ---

            ğŸ“ˆ **Coverage Trends**: View detailed coverage report in [build artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            <details>
            <summary>ğŸ“‹ Quality Checklist</summary>

            - [${getStatus(statements, 80) === 'âœ…' ? 'x' : ' '}] Statement coverage â‰¥80%
            - [${getStatus(branches, 75) === 'âœ…' ? 'x' : ' '}] Branch coverage â‰¥75%
            - [${getStatus(functions, 85) === 'âœ…' ? 'x' : ' '}] Function coverage â‰¥85%
            - [${getStatus(lines, 80) === 'âœ…' ? 'x' : ' '}] Line coverage â‰¥80%
            - [${qualityGate.includes('PASSED') ? 'x' : ' '}] Quality gate passed

            </details>

            *Coverage report generated at ${new Date().toISOString()}*
            `;

            // Look for existing coverage comment to update
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const existingComment = comments.find(comment =>
              comment.body.includes('## ğŸ“Š Test Coverage Report')
            );

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  # Job 4: Performance Analysis
  performance-analysis:
    name: âš¡ Performance Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: full-validation
    if: github.event.pull_request.draft == false && success()

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ—ï¸ Build for Analysis
        run: npm run build:prod

      - name: ğŸ“ Bundle Size Analysis
        run: |
          BUNDLE_SIZE=$(du -sk dist/ | cut -f1)
          MAX_SIZE=2048

          echo "BUNDLE_SIZE=$BUNDLE_SIZE" >> $GITHUB_ENV
          echo "MAX_SIZE=$MAX_SIZE" >> $GITHUB_ENV

          if [ "$BUNDLE_SIZE" -le "$MAX_SIZE" ]; then
            echo "BUNDLE_STATUS=âœ… PASSED" >> $GITHUB_ENV
          else
            echo "BUNDLE_STATUS=âŒ FAILED" >> $GITHUB_ENV
          fi

      - name: ğŸ’¬ Performance Comment
        uses: actions/github-script@v7
        with:
          script: |
            const bundleSize = process.env.BUNDLE_SIZE;
            const maxSize = process.env.MAX_SIZE;
            const status = process.env.BUNDLE_STATUS;

            const comment = `## âš¡ Performance Analysis

            | Metric | Value | Limit | Status |
            |--------|-------|--------|--------|
            | Bundle Size | ${bundleSize} KB | ${maxSize} KB | ${status} |

            ${status.includes('FAILED') ?
              'âš ï¸ **Bundle size exceeds limit**. Consider code splitting or removing unused dependencies.' :
              'âœ… **Bundle size within limits**. Great job keeping it lean!'
            }
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Job 5: Security Check
  security-check:
    name: ğŸ”’ Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: full-validation
    if: github.event.pull_request.draft == false

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ”’ Security Audit
        run: |
          if npm audit --audit-level high --production; then
            echo "SECURITY_STATUS=âœ… No high-severity vulnerabilities" >> $GITHUB_ENV
          else
            echo "SECURITY_STATUS=âŒ Security vulnerabilities found" >> $GITHUB_ENV
          fi

      - name: ğŸ’¬ Security Status Comment
        uses: actions/github-script@v7
        with:
          script: |
            const status = process.env.SECURITY_STATUS;

            const comment = `## ğŸ”’ Security Analysis

            **Status**: ${status}

            ${status.includes('âŒ') ?
              'âš ï¸ **Action Required**: Please run `npm audit fix` to resolve security issues.' :
              'âœ… **Security check passed**. No high-severity vulnerabilities found.'
            }
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Job 6: PR Status Check
  pr-status-check:
    name: ğŸ¯ PR Status Summary
    runs-on: ubuntu-latest
    timeout-minutes: 2
    needs: [full-validation, coverage-analysis, performance-analysis, security-check]
    if: always() && github.event.pull_request.draft == false

    steps:
      - name: ğŸ“Š Determine Overall Status
        run: |
          VALIDATION_STATUS="${{ needs.full-validation.result }}"
          COVERAGE_STATUS="${{ needs.coverage-analysis.result }}"
          PERFORMANCE_STATUS="${{ needs.performance-analysis.result }}"
          SECURITY_STATUS="${{ needs.security-check.result }}"

          echo "Validation: $VALIDATION_STATUS"
          echo "Coverage: $COVERAGE_STATUS"
          echo "Performance: $PERFORMANCE_STATUS"
          echo "Security: $SECURITY_STATUS"

          if [[ "$VALIDATION_STATUS" == "success" && "$COVERAGE_STATUS" == "success" ]]; then
            echo "OVERALL_STATUS=âœ… READY FOR REVIEW" >> $GITHUB_ENV
            echo "STATUS_COLOR=28a745" >> $GITHUB_ENV
          else
            echo "OVERALL_STATUS=âŒ NEEDS WORK" >> $GITHUB_ENV
            echo "STATUS_COLOR=dc3545" >> $GITHUB_ENV
          fi

      - name: ğŸ·ï¸ Update PR Labels
        uses: actions/github-script@v7
        with:
          script: |
            const status = process.env.OVERALL_STATUS;

            // Remove existing status labels
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const statusLabels = labels.filter(label =>
              label.name.includes('âœ…') || label.name.includes('âŒ')
            );

            for (const label of statusLabels) {
              await github.rest.issues.removeLabel({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: label.name
              });
            }

            // Add new status label
            const newLabel = status.includes('âœ…') ? 'âœ… ready-for-review' : 'âŒ needs-work';

            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: [newLabel]
            });
