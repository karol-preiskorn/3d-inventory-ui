<!DOCTYPE html>
<html>

<head>
  <title>3D Inventory Authentication Debugger</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 20px;
      line-height: 1.6;
      background-color: #f8f9fa;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .token {
      word-break: break-all;
      background: #f8f9fa;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      border-left: 4px solid #007bff;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 12px;
    }

    .status {
      padding: 15px;
      margin: 15px 0;
      border-radius: 8px;
      font-weight: 500;
    }

    .authenticated {
      background: #d1edff;
      color: #0c5460;
      border-left: 4px solid #0dcaf0;
    }

    .not-authenticated {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid #dc3545;
    }

    .warning {
      background: #fff3cd;
      color: #856404;
      border-left: 4px solid #ffc107;
    }

    .section {
      margin: 30px 0;
      padding: 20px;
      border: 1px solid #dee2e6;
      border-radius: 8px;
    }

    .section h3 {
      margin-top: 0;
      color: #495057;
      border-bottom: 2px solid #dee2e6;
      padding-bottom: 10px;
    }

    .btn {
      background: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }

    .btn:hover {
      background: #0056b3;
    }

    .btn-danger {
      background: #dc3545;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      border-left: 4px solid #6c757d;
    }

    .test-result {
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
    }

    .test-success {
      background: #d1edff;
      border-left: 4px solid #0dcaf0;
    }

    .test-failure {
      background: #f8d7da;
      border-left: 4px solid #dc3545;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üîê 3D Inventory Authentication Debugger</h1>
    <p>This tool helps debug authentication issues when creating attribute dictionaries.</p>

    <div class="section">
      <h3>üîç Current Authentication Status</h3>
      <div id="authStatus"></div>
    </div>

    <div class="section">
      <h3>üé´ JWT Token Analysis</h3>
      <div id="tokenAnalysis"></div>
    </div>

    <div class="section">
      <h3>üë§ User Information</h3>
      <div id="userInfo"></div>
    </div>

    <div class="section">
      <h3>üîß API Test</h3>
      <p>Test the actual API endpoint with your current token:</p>
      <button class="btn" onclick="testAPI()">Test API Call</button>
      <button class="btn" onclick="testLogin()">Test Login Endpoint</button>
      <div id="apiTest"></div>
    </div>

    <div class="section">
      <h3>üßπ Troubleshooting Actions</h3>
      <button class="btn btn-danger" onclick="clearAuth()">Clear All Auth Data</button>
      <button class="btn" onclick="goToLogin()">Go to Login Page</button>
      <button class="btn" onclick="refresh()">Refresh Analysis</button>
    </div>

    <div class="section">
      <h3>üìä LocalStorage Contents</h3>
      <div id="storageContents"></div>
    </div>
  </div>

  <script>
    function analyzeAuth() {
      const token = localStorage.getItem('auth_token')
      const user = localStorage.getItem('auth_user')

      const authStatusDiv = document.getElementById('authStatus')
      const tokenDiv = document.getElementById('tokenAnalysis')
      const userDiv = document.getElementById('userInfo')
      const storageDiv = document.getElementById('storageContents')

      // Authentication Status
      if (token && token.trim() !== '') {
        authStatusDiv.innerHTML = '<div class="status authenticated">‚úÖ JWT Token found in localStorage</div>'

        // Token Analysis
        try {
          const parts = token.split('.')
          if (parts.length !== 3) {
            throw new Error('Invalid JWT format - should have 3 parts separated by dots')
          }

          const header = JSON.parse(atob(parts[0]))
          const payload = JSON.parse(atob(parts[1]))
          const now = Date.now() / 1000
          const expired = payload.exp && payload.exp < now

          tokenDiv.innerHTML = `
                        <div class="status ${expired ? 'not-authenticated' : 'authenticated'}">
                            ${expired ? '‚ùå Token is EXPIRED' : '‚úÖ Token is VALID and NOT EXPIRED'}
                        </div>
                        <div class="token">
                            <strong>Token (first 50 chars):</strong><br>
                            ${token.substring(0, 50)}...
                        </div>
                        <h4>Token Header:</h4>
                        <pre>${JSON.stringify(header, null, 2)}</pre>
                        <h4>Token Payload:</h4>
                        <pre>${JSON.stringify(payload, null, 2)}</pre>
                        <div class="status ${expired ? 'not-authenticated' : 'authenticated'}">
                            <strong>Issued:</strong> ${payload.iat ? new Date(payload.iat * 1000).toLocaleString() : 'Not specified'}<br>
                            <strong>Expires:</strong> ${payload.exp ? new Date(payload.exp * 1000).toLocaleString() : 'Not specified'}<br>
                            <strong>User ID:</strong> ${payload.userId || payload.sub || 'Not found'}<br>
                            <strong>Username:</strong> ${payload.username || 'Not found'}
                        </div>
                    `

          if (expired) {
            tokenDiv.innerHTML += '<div class="status not-authenticated">‚ö†Ô∏è Your token has expired. You need to log in again.</div>'
          }

        } catch (e) {
          tokenDiv.innerHTML = `
                        <div class="status not-authenticated">‚ùå Cannot decode JWT token</div>
                        <div class="status not-authenticated">Error: ${e.message}</div>
                        <div class="token">
                            <strong>Raw Token:</strong><br>
                            ${token}
                        </div>
                    `
        }
      } else {
        authStatusDiv.innerHTML = '<div class="status not-authenticated">‚ùå No JWT token found in localStorage</div>'
        tokenDiv.innerHTML = '<div class="status not-authenticated">No token to analyze</div>'
      }

      // User Information
      if (user && user.trim() !== '') {
        try {
          const userObj = typeof user === 'string' ? JSON.parse(user) : user
          userDiv.innerHTML = `
                        <div class="status authenticated">‚úÖ User data found</div>
                        <pre>${JSON.stringify(userObj, null, 2)}</pre>
                    `
        } catch (e) {
          userDiv.innerHTML = `
                        <div class="status not-authenticated">‚ùå Cannot parse user data</div>
                        <div class="token">${user}</div>
                    `
        }
      } else {
        userDiv.innerHTML = '<div class="status not-authenticated">‚ùå No user data found in localStorage</div>'
      }

      // Storage Contents
      const allStorage = {}
      for (let i = 0;i < localStorage.length;i++) {
        const key = localStorage.key(i)
        allStorage[key] = localStorage.getItem(key)
      }
      storageDiv.innerHTML = `<pre>${JSON.stringify(allStorage, null, 2)}</pre>`
    }

    async function testAPI() {
      const token = localStorage.getItem('auth_token')
      const testDiv = document.getElementById('apiTest')

      if (!token) {
        testDiv.innerHTML = '<div class="test-result test-failure">‚ùå No token available for testing</div>'
        return
      }

      testDiv.innerHTML = '<div class="status warning">üîÑ Testing API...</div>'

      try {
        // Test the actual attributesDictionary endpoint
        const response = await fetch('https://3d-inventory-api.ultimasolution.pl/attributesDictionary/', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        })

        if (response.ok) {
          const data = await response.json()
          testDiv.innerHTML = `
                        <div class="test-result test-success">‚úÖ API call successful! Status: ${response.status}</div>
                        <pre>Response: ${JSON.stringify(data, null, 2)}</pre>
                    `
        } else {
          const errorText = await response.text()
          testDiv.innerHTML = `
                        <div class="test-result test-failure">‚ùå API call failed! Status: ${response.status}</div>
                        <pre>Error: ${errorText}</pre>
                    `
        }
      } catch (error) {
        testDiv.innerHTML = `
                    <div class="test-result test-failure">‚ùå Network error: ${error.message}</div>
                `
      }
    }

    async function testLogin() {
      const testDiv = document.getElementById('apiTest')
      testDiv.innerHTML = '<div class="status warning">üîÑ Testing login endpoint...</div>'

      try {
        const response = await fetch('https://3d-inventory-api.ultimasolution.pl/auth/status', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        })

        const data = await response.text()
        testDiv.innerHTML = `
                    <div class="test-result ${response.ok ? 'test-success' : 'test-failure'}">
                        Auth status endpoint: ${response.status}
                    </div>
                    <pre>${data}</pre>
                `
      } catch (error) {
        testDiv.innerHTML = `
                    <div class="test-result test-failure">‚ùå Cannot reach auth endpoint: ${error.message}</div>
                `
      }
    }

    function clearAuth() {
      if (confirm('Are you sure you want to clear all authentication data?')) {
        localStorage.removeItem('auth_token')
        localStorage.removeItem('auth_user')
        localStorage.removeItem('user')
        localStorage.removeItem('token')
        alert('Authentication data cleared!')
        analyzeAuth()
      }
    }

    function goToLogin() {
      window.location.href = '/login'
    }

    function refresh() {
      analyzeAuth()
    }

    // Run analysis on page load
    analyzeAuth()

    // Auto-refresh every 30 seconds
    setInterval(analyzeAuth, 30000);
  </script>
</body>

</html>
